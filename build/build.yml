parameters: 
  buildConfiguration: 'Release'

variables:
  npm_config_cache: $(Pipeline.Workspace)/.npm
  nuget_packages: $(Pipeline.Workspace)/.nuget/packages

stages:
  - stage: Build
    jobs:
      - job: Build
        steps:

        # Restore npm packages
        - task: Cache@2
          inputs:
            key: npm | $(Agent.OS) | Web\package-lock.json
            path: $(npm_config_cache)
          displayName: Cache npm
        - script: npm ci
          workingDirectory: Web

        # Restore nuget packages                
        - task: Cache@2
          inputs:
            key: 'nuget | "$(Agent.OS)" | paket.lock'
            restoreKeys: |
              nuget | "$(Agent.OS)"
              nuget
            path: $(nuget_packages)
          displayName: Cache NuGet packages
        - script: dotnet tool restore
        - script: dotnet paket restore
        
        # Build frontend and backend
        - script: dotnet build openspace.sln --configuration $(buildConfiguration)
        - script: npm run publish
          workingDirectory: Web
        
        # Publish app
        - script: dotnet publish Web.csproj --configuration $(buildConfiguration) --output $(build.artifactstagingdirectory)
          workingDirectory: Web
        - publish: $(build.artifactstagingdirectory)
          artifact: WebApp