parameters: 
  buildConfiguration: 'Release'
  
  npm_config_cache: $(Pipeline.Workspace)/.npm
  nuget_packages: $(Pipeline.Workspace)/.nuget/packages

stages:
  - stage: Build
    jobs:
      - job: Build
        steps:
        - task: UseDotNet@2
          inputs:
            packageType: 'sdk'
            useGlobalJson: true

        # Restore npm packages
        - task: Cache@2
          inputs:
            key: npm | $(Agent.OS) | **/package-lock.json
            path: ${{ parameters.npm_config_cache }}
          displayName: Cache npm
        - script: npm ci
          workingDirectory: Web

        # Restore nuget packages                
        - task: Cache@2
          inputs:
            key: 'nuget | "$(Agent.OS)" | **/paket.lock'
            restoreKeys: |
              nuget | "$(Agent.OS)"
              nuget
            path: ${{ parameters.nuget_packages }}
          displayName: Cache NuGet packages
        - script: dotnet tool restore
        - script: dotnet paket restore
        
        # Build frontend and backend
        - script: dotnet build openspace.sln --configuration ${{ parameters.buildConfiguration }}
        - script: npm run publish
          workingDirectory: Web
        
        # Publish app
        - script: dotnet publish Web.csproj --configuration ${{ parameters.buildConfiguration }} --output $(build.artifactstagingdirectory)
          workingDirectory: Web
        - publish: $(build.artifactstagingdirectory)
          artifact: WebApp